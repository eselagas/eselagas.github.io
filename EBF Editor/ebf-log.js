(async()=>{let e="";const t="eselagas",a="app.files",s="stats.json",n="anonymousUserId",r="userVisitCount",o="userSessionStart",i="lastActivity",c="sessionId";let l=localStorage.getItem(n)||crypto.randomUUID();localStorage.setItem(n,l);let y=localStorage.getItem(c),u=parseInt(localStorage.getItem(o)),g=parseInt(localStorage.getItem(i)),d=parseInt(localStorage.getItem(r))||0;const m=Date.now();await async function(){try{const t=await fetch("https://ethanselagea.weebly.com/uploads/1/5/0/7/150702136/token.txt");if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);e=await t.text()}catch(e){console.error("Error fetching file:",e)}}(),y&&u&&g&&!(m-g>18e5)||(y=crypto.randomUUID(),u=m,d++,localStorage.setItem(c,y),localStorage.setItem(o,u.toString()),localStorage.setItem(r,d.toString())),g=m,localStorage.setItem(i,g.toString());const h=e=>new Promise((t=>setTimeout(t,e))),p=async(e,t=3)=>{for(let a=0;a<t;a++)try{return await e()}catch(e){if(a===t-1)throw e;await h(1e3*Math.pow(2,a))}};let w=null,f=null,v=0;const S=()=>{g=Date.now(),localStorage.setItem(i,g.toString())};["click","keydown","mousemove","touchstart"].forEach((e=>{document.addEventListener(e,S,{passive:!0})}));let D=!document.hidden,b=Date.now();const P=async()=>{try{let{stats:n,sha:r}=await(async()=>{const n=Date.now();return w&&n-v<12e4?{stats:w,sha:f}:p((async()=>{const r=await fetch(`https://api.github.com/repos/${t}/${a}/contents/${s}`,{headers:{Authorization:`Bearer ${e}`}});if(!r.ok)throw new Error(`HTTP Error: ${r.status}`);const{content:o,sha:i}=await r.json(),c=JSON.parse(atob(o));return w=c,f=i,v=n,console.log("[EBF Analytics]: Starting..."),{stats:c,sha:i}}))})();n&&"object"==typeof n||(n={uniqueUsers:{},totalVisits:0,totalSessions:0,analytics:{daily:{},hourly:{},weekly:{},monthly:{},quarterly:{},referrers:{},devices:{},browsers:{},locations:{},pages:{},searchParams:{},deviceTypes:{},connectionTypes:{},timeOfDay:{},sessionDurations:[],bounceRate:{total:0,bounced:0},returnVisitors:{total:0,returning:0}},performance:{avgSessionDuration:0,avgPagesPerSession:0,totalPageViews:0,peakHours:{},popularPages:{},userEngagement:{highlyEngaged:0,moderatelyEngaged:0,quickVisits:0}},metadata:{lastUpdated:Date.now(),version:"2.0"}},r=null),n.analytics||(n.analytics={}),n.performance||(n.performance={}),n.metadata||(n.metadata={}),n.uniqueUsers||(n.uniqueUsers={}),Object.assign(n.analytics,{daily:n.analytics.daily||{},hourly:n.analytics.hourly||{},weekly:n.analytics.weekly||{},monthly:n.analytics.monthly||{},quarterly:n.analytics.quarterly||{},referrers:n.analytics.referrers||{},devices:n.analytics.devices||{},browsers:n.analytics.browsers||{},locations:n.analytics.locations||{},pages:n.analytics.pages||{},searchParams:n.analytics.searchParams||{},deviceTypes:n.analytics.deviceTypes||{},connectionTypes:n.analytics.connectionTypes||{},timeOfDay:n.analytics.timeOfDay||{},sessionDurations:n.analytics.sessionDurations||[],bounceRate:n.analytics.bounceRate||{total:0,bounced:0},returnVisitors:n.analytics.returnVisitors||{total:0,returning:0}}),n.performance.userEngagement||(n.performance.userEngagement={highlyEngaged:0,moderatelyEngaged:0,quickVisits:0});const o=Date.now(),i=o-u,c=(()=>{const e=navigator.userAgent,t=navigator.connection||navigator.mozConnection||navigator.webkitConnection;let a="Unknown",s="";e.includes("Chrome")?(a=e.includes("Edg")?"Edge":"Chrome",s=e.match(/Chrome\/(\d+)/)?.[1]||""):e.includes("Firefox")?(a="Firefox",s=e.match(/Firefox\/(\d+)/)?.[1]||""):e.includes("Safari")&&!e.includes("Chrome")&&(a="Safari",s=e.match(/Version\/(\d+)/)?.[1]||"");const n=/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(e),r=/iPad|Android(?!.*Mobile)/i.test(e)?"tablet":n?"mobile":"desktop";return{userAgent:e,browser:a,browserVersion:s,language:navigator.language,languages:navigator.languages||[navigator.language],platform:navigator.platform,deviceType:r,screen:`${screen.width}x${screen.height}`,colorDepth:screen.colorDepth,pixelRatio:window.devicePixelRatio||1,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,referrer:document.referrer||"direct",url:location.href,pathname:location.pathname,search:location.search,hash:location.hash,viewport:`${window.innerWidth}x${window.innerHeight}`,cookieEnabled:navigator.cookieEnabled,onLine:navigator.onLine,memory:navigator.deviceMemory||"unknown",cores:navigator.hardwareConcurrency||"unknown",connectionType:t?.effectiveType||"unknown",downlink:t?.downlink||"unknown"}})(),g=(e=>{const t=new Date(e),a=new Date(t.getFullYear(),0,1),s=Math.floor((t-a)/864e5)+1,n=Math.ceil(s/7);return{timestamp:e,year:t.getFullYear(),month:t.getMonth()+1,day:t.getDate(),hour:t.getHours(),minute:t.getMinutes(),dayOfWeek:t.getDay(),dayOfYear:s,weekOfYear:n,quarter:Math.ceil((t.getMonth()+1)/3),isWeekend:0===t.getDay()||6===t.getDay(),timeOfDay:t.getHours()<6?"night":t.getHours()<12?"morning":t.getHours()<18?"afternoon":"evening"}})(o),d=Math.max(0,Math.min(23,g.hour)),m=Math.max(0,Math.min(6,g.dayOfWeek)),h=Math.max(0,Math.min(11,g.month-1)),S=!n.uniqueUsers[l];S&&(n.uniqueUsers[l]={totalAccesses:0,totalSessions:0,firstVisit:o,lastAccess:o,sessions:[],devices:[],referrers:[],pages:[],totalTimeSpent:0,avgSessionDuration:0,timePatterns:{hourly:new Array(24).fill(0),daily:new Array(7).fill(0),monthly:new Array(12).fill(0)}});const D=n.uniqueUsers[l];D.devices=D.devices||[],D.referrers=D.referrers||[],D.pages=D.pages||[],D.sessions=D.sessions||[],D.timePatterns&&Array.isArray(D.timePatterns.hourly)&&24===D.timePatterns.hourly.length||(D.timePatterns={hourly:new Array(24).fill(0),daily:new Array(7).fill(0),monthly:new Array(12).fill(0)}),D.totalAccesses++,D.lastAccess=o,D.totalTimeSpent+=i;const b={id:y,start:u,duration:i,timestamp:o,page:c.pathname,referrer:c.referrer,device:c.deviceType,browser:c.browser,isNewSession:0===D.sessions.length||!D.sessions.some((e=>e.id===y))},P=D.sessions.findIndex((e=>e.id===y));P>=0?D.sessions[P]=b:(D.sessions.push(b),D.totalSessions++,n.totalSessions++),D.sessions.length>50&&(D.sessions=D.sessions.slice(-50)),D.timePatterns.hourly&&d>=0&&d<24&&D.timePatterns.hourly[d]++,D.timePatterns.daily&&m>=0&&m<7&&D.timePatterns.daily[m]++,D.timePatterns.monthly&&h>=0&&h<12&&D.timePatterns.monthly[h]++,D.avgSessionDuration=D.totalSessions>0?D.totalTimeSpent/D.totalSessions:0;const E=`${c.platform}-${c.browser}`;D.devices.includes(E)||D.devices.push(E),D.referrers.includes(c.referrer)||D.referrers.push(c.referrer),D.pages.includes(c.pathname)||D.pages.push(c.pathname),b.isNewSession&&n.totalVisits++;const k=`${g.year}-${String(g.month).padStart(2,"0")}-${String(g.day).padStart(2,"0")}`,$=`${g.year}-W${String(g.weekOfYear).padStart(2,"0")}`,T=`${g.year}-${String(g.month).padStart(2,"0")}`,I=`${g.year}-Q${g.quarter}`;if(n.analytics.daily[k]=(n.analytics.daily[k]||0)+1,n.analytics.weekly[$]=(n.analytics.weekly[$]||0)+1,n.analytics.monthly[T]=(n.analytics.monthly[T]||0)+1,n.analytics.quarterly[I]=(n.analytics.quarterly[I]||0)+1,n.analytics.hourly[d]=(n.analytics.hourly[d]||0)+1,n.analytics.timeOfDay[g.timeOfDay]=(n.analytics.timeOfDay[g.timeOfDay]||0)+1,n.analytics.referrers[c.referrer]=(n.analytics.referrers[c.referrer]||0)+1,n.analytics.devices[c.platform]=(n.analytics.devices[c.platform]||0)+1,n.analytics.browsers[c.browser]=(n.analytics.browsers[c.browser]||0)+1,n.analytics.locations[c.timezone]=(n.analytics.locations[c.timezone]||0)+1,n.analytics.pages[c.pathname]=(n.analytics.pages[c.pathname]||0)+1,n.analytics.deviceTypes[c.deviceType]=(n.analytics.deviceTypes[c.deviceType]||0)+1,n.analytics.connectionTypes[c.connectionType]=(n.analytics.connectionTypes[c.connectionType]||0)+1,c.search)try{new URLSearchParams(c.search).forEach(((e,t)=>{if(["utm_source","utm_medium","utm_campaign"].includes(t)){const a=`${t}=${e}`;n.analytics.searchParams[a]=(n.analytics.searchParams[a]||0)+1}}))}catch(e){console.warn("Error parsing search parameters:",e)}n.analytics.sessionDurations.push(i),n.analytics.sessionDurations.length>1e3&&(n.analytics.sessionDurations=n.analytics.sessionDurations.slice(-1e3)),n.analytics.bounceRate.total++,i<1e4&&n.analytics.bounceRate.bounced++,n.analytics.returnVisitors.total++,S||n.analytics.returnVisitors.returning++;const A=n.analytics.sessionDurations;n.performance.avgSessionDuration=A.length>0?A.reduce(((e,t)=>e+t),0)/A.length:0,n.performance.totalPageViews=Object.values(n.analytics.pages).reduce(((e,t)=>e+t),0),n.performance.avgPagesPerSession=n.totalSessions>0?n.performance.totalPageViews/n.totalSessions:0;const O=i/6e4;O>5?n.performance.userEngagement.highlyEngaged++:O>1?n.performance.userEngagement.moderatelyEngaged++:n.performance.userEngagement.quickVisits++;try{n.performance.popularPages=Object.entries(n.analytics.pages).sort((([,e],[,t])=>t-e)).slice(0,10).reduce(((e,[t,a])=>({...e,[t]:a})),{})}catch(e){console.warn("Error updating popular pages:",e),n.performance.popularPages={}}n.metadata.lastUpdated=o,n.metadata.version="2.0";const U=btoa(JSON.stringify(n,null,2));await p((async()=>{const o=await fetch(`https://api.github.com/repos/${t}/${a}/contents/${s}`,{method:"PUT",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({message:`Analytics update - User ${l.slice(0,8)} - Session ${y.slice(0,8)} - Duration ${Math.round(i/1e3)}s`,content:U,sha:r})});if(!o.ok)throw new Error(`GitHub API Error: ${o.status}`);const c=await o.json();w=n,f=c.content.sha})),console.log("[EBF Analytics]: Analytics updated successfully.")}catch(e){console.error("Analytics update failed:",e)}};await P();const E=setInterval(P,12e4),k=async()=>{if(clearInterval(E),navigator.sendBeacon)try{const e={userId:l.slice(0,8),sessionId:y.slice(0,8),duration:Date.now()-u};navigator.sendBeacon("/analytics-beacon",JSON.stringify(e))}catch(e){await P()}else await P()};window.addEventListener("beforeunload",k),window.addEventListener("pagehide",k),window.addEventListener("focus",(()=>{D||(D=!0,b=Date.now())})),window.addEventListener("blur",(()=>{D&&(D=!1)})),window.analytics={getUserId:()=>l.slice(0,8),getSessionId:()=>y.slice(0,8),getSessionDuration:()=>Date.now()-u,forceUpdate:P}})();
